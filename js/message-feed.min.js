"use strict";var app={};app.Page=Backbone.Model.extend({initialize:function(){this.bind("change:addedMessagesCount",this.onAddedCountChanged),this.bind("change:removedMessagesCount",this.onRemovedCountChanged)},defaults:{id:1,addedMessagesCount:0,removedMessagesCount:0},localStorage:new Store("page-store"),incrementAddedCount:function(){var e=this.get("addedMessagesCount")+1;this.set({addedMessagesCount:e})},incrementRemovedCount:function(){var e=this.get("removedMessagesCount")+1;this.set({removedMessagesCount:e})},onAddedCountChanged:function(){this.trigger("addedCountChanged",this.get("addedMessagesCount"))},onRemovedCountChanged:function(){this.trigger("removedCountChanged",this.get("removedMessagesCount"))}}),app.Message=Backbone.Model.extend({defaults:{messageAuthor:"Anonymous",messageText:"",time:"0:0:0"},validate:function(e){var t=[];return e.messageText||t.push("Message text cannot be empty."),t.length>0?t:!1}}),app.MessageList=Backbone.Collection.extend({model:app.Message,localStorage:new Store("message-feed")}),app.MessageView=Backbone.View.extend({tagName:"li",className:"message-item l-box pure-u-22-24 pure-u-md-11-24",template:_.template($("#message-template").html()),initialize:function(){this.model.on("destroy",this.remove,this)},render:function(){return this.$el.html(this.template(this.model.toJSON())),this},events:{"click .remove-btn":"onRemoveBtnClicked"},onRemoveBtnClicked:function(){this.model.destroy()}}),app.ApplicationView=Backbone.View.extend({el:"#app-container",initialize:function(e){this.model=e,this.authorInput=this.$("#message-author-input"),this.textInput=this.$("#message-text-input"),app.messageList.on("add",this.onMessageAdded,this),app.messageList.on("remove",this.onMessageRemoved,this),app.messageList.on("reset",this.onMessageListReset,this),this.model.on("addedCountChanged",this.onAddedCountChanged,this),this.model.on("removedCountChanged",this.onRemovedCountChanged,this),this.model.fetch({error:this.updateCounters,success:this.updateCounters}),app.messageList.fetch()},events:{"click #submit-message-btn":"onSubmitBtnClicked"},updateCounters:function(e){var t=e.get("addedMessagesCount");$("#added-messages-count").html(t);var s=e.get("removedMessagesCount");$("#removed-messages-count").html(s)},validateMessage:function(){return""!=this.textInput.val().trim()},onSubmitBtnClicked:function(){var e=this;app.messageList.create(this.newMessageData(),{success:function(){e.model.incrementAddedCount(),e.model.save(),e.authorInput.val(""),e.textInput.val("")},error:function(t,s){e.showValidationErrors(s)}})},showValidationErrors:function(e){$("#message-validation-error").html(e[0])},onMessageAdded:function(e){var t=new app.MessageView({model:e});$("#message-list").append(t.render().el)},newMessageData:function(){var e=(this.authorInput.val().trim(),""!=this.authorInput.val().trim()?this.authorInput.val().trim():"Anonymous");return{messageAuthor:e,messageText:this.textInput.val().trim(),time:this.getMessageDateTime()}},getMessageDateTime:function(){return(new Date).toLocaleString()},onMessageRemoved:function(){this.model.incrementRemovedCount(),this.model.save()},onMessageListReset:function(){this.$("#message-list").html(""),app.messageList.each(this.onMessageAdded,this)},onAddedCountChanged:function(e){$("#added-messages-count").html(e)},onRemovedCountChanged:function(e){$("#removed-messages-count").html(e)}}),app.messageList=new app.MessageList,app.page=new app.Page,app.applicationView=new app.ApplicationView(app.page);